<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet id="create_user" author="author">
        <preConditions>
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <sql>
            CREATE table users (
                id bigserial primary key,
                name varchar unique,
                password varchar,
                email varchar unique
            )
        </sql>
    </changeSet>
    <changeSet id="create_role" author="author">
        <preConditions>
            <not>
                <tableExists tableName="user_roles"/>
            </not>
        </preConditions>
        <sql>
            CREATE table user_roles (
                id bigserial primary key,
                role varchar,
                user_id bigint references users(id)
            )
        </sql>
    </changeSet>

    <changeSet id="hotels" author="author">
    <preConditions>
        <not>
            <tableExists tableName="hotels"/>
        </not>
    </preConditions>
    <sql>
        CREATE table hotels (
        id bigserial primary key ,
        name varchar,
        title varchar,
        city varchar,
        address varchar,
        distance_from_city_center bigint,
        rating bigint,
        number_of_ratings bigint
        )
    </sql>
    </changeSet>
    <changeSet id="rooms" author="author">
        <preConditions>
            <not>
                <tableExists tableName="rooms"/>
            </not>
        </preConditions>
        <sql>
            CREATE table rooms (
            id bigserial primary key ,
            name varchar,
            description varchar,
            number bigint,
            price bigint,
            max_number_of_guests bigint,
            unavailable_dates date,
            hotel_id bigint references hotels(id)
            )
        </sql>
    </changeSet>
    <changeSet id="bookings" author="author">
        <preConditions>
            <not>
                <tableExists tableName="bookings"/>
            </not>
        </preConditions>
        <sql>
            CREATE table bookings (
            id bigserial primary key,
            arrival_date date,
            departure_date date,
            room_id bigint references rooms(id),
            user_id bigint references users(id)
            )
        </sql>
    </changeSet>
    <changeSet id="hotel_marks" author="author">
        <preConditions>
            <not>
                <tableExists tableName="hotel_marks"/>
            </not>
        </preConditions>
        <sql>
            CREATE table hotel_marks (
                id bigserial primary key ,
                mark bigint,
                user_id bigint references users(id),
                hotel_id bigint references hotels(id)
            )
        </sql>
    </changeSet>

    <changeSet id="fixrole" author="me">
        <createTable tableName="role">
            <column name="id" type="bigserial">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar"/>
        </createTable>

        <addColumn tableName="user_roles">
            <column name="role_id" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="1766492327435-1" author="arsla (generated)">
        <insert tableName="role">
            <column name="name" value="admin"/>
        </insert>
        <insert tableName="role">
            <column name="name" value="user"/>
        </insert>
    </changeSet>

    <changeSet id="1766492477981-1" author="arsla (generated)">
        <sql>
            UPDATE user_roles SET role_id = role.id from role where role.name = user_roles.role
        </sql>
    </changeSet>

    <changeSet id="1766492684336-1" author="arsla (generated)">
        <dropColumn tableName="user_roles" columnName="role"/>
    </changeSet>

    <changeSet id="1766493568248-1" author="arsla (generated)">
        <dropColumn tableName="hotels" columnName="rating"/>
        <dropColumn tableName="hotels" columnName="number_of_ratings"/>
    </changeSet>

    <changeSet id="1766492684335-1" author="arsla (generated)">
        <dropColumn tableName="rooms" columnName="unavailable_dates"/>
    </changeSet>


    <changeSet id="1766492684334-1" author="author">
        <preConditions>
            <not>
                <tableExists tableName="unavailable_dates"/>
            </not>
        </preConditions>
        <sql>
            CREATE table unavailable_dates (
                id bigserial primary key,
                room_id bigint references rooms(id),
                unavailable_date DATE
            )
        </sql>
    </changeSet>

    <changeSet id="123456" author="author">
        <addColumn tableName="unavailable_dates">
            <column name="type" type="varchar"/>
        </addColumn>

        <sql>
            UPDATE unavailable_dates SET type = 'UNAVAILABLE' WHERE type is null;
        </sql>
    </changeSet>


</databaseChangeLog>